---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Final Project: Patterns of Lemur Density in Ranomafana National Park, Madagascar"
subtitle: "https://github.com/ag522/LemurProject_DeSisto_Gonzalez_Horn.git"
author: "Camille DeSisto, Andrea Gonzalez, Courtney Horn"
fontsize: 12pt
mainfont: Times New Roman

---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()
# Load your packages
library(lme4)
require(lmerTest)
require(lmtest)
library(corrplot)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(agricolae)
library(sf)
library(leaflet)
library(mapview)
library(MuMIn)
library(htmltools)
library(agricolae)
# Set your ggplot theme
# Load your datasets
lemur_data <- read.csv("872_data.csv", header=T)

```


# Rationale and Research Questions

Madagascar is one of Earth’s biodiversity hotspots that harbors high levels of animal and plant endemism. Climate, land cover, and geography determine patterns of plant community structure throughout the island which, in turn, effects mammal diversity (Brown et al. 2015; Park & Razafindratsima 2019). Lemurs, Madagascar’s most prominent group of frugivores by both biomass and species richness, play a critical role in seed dispersal and related processes and are important cultural icons (Wright et al. 2005).  However, 91% of lemurs are threatened with extinction due to anthropogenic disturbances (Schwitzer et al. 2013; Razafindratsima et al. 2013).

Lemur habitat use is dependent on plant resource availability (Overdorff 1996), which is mediated by landscape-level characteristics such as roughness and slope. In fact, food trees are stronger predictors of lemur occurrence than climate (Herrera et al. 2017). Lemurs use trait-based cues to select fruits (Valenta et al. 2013; Overdorff 1996). For example, size matching, whereby large fruits are typically dispersed by large vertebrates, is an essential phenomenon in driving plant-frugivore interactions (Lim et al. 2020).  Plant nutrient content may also be an important factor in influencing frugivory interactions in tropical forests. Madagascar is the only region where there is a significant relationship between fruit protein and the degree of frugivory among primate communities (Donati et al. 2017). Additionally, the average percentage of fruit nitrogen content in Madagascar is lower than the minimum nitrogen requirement for primates, suggesting that the low protein availability in Malagasy fruits is particularly important in shaping lemur communities (Donati et al. 2017). 

In this project, we examine a suite of environmental factors in relation to lemur densities in Ranomafana National Park, Madagascar. We seek to identify patterns in lemur densities throughout the park and examine potential causes of these patterns. Because different lemur species have specific responses to environmental cues based on their life history traits, we hypothesize that lemur densities among different sites and species are significantly different. Additionally, we expect that both landscape-level characteristics and plant functional traits act together to drive lemur densities throughout a national park in Madagascar. Specifically, we predict that a) lemur densities are negatively related to landscape roughness and slope and b) reward regulation causes positive relationships between animal densities and fruit nutrient contents. 


\newpage

# Dataset Information
Data for this project were collected by James Herrera and Camille DeSisto, as a part of a larger project aimed at investigating plant-animal interactions in Madagascar's eastern rainforests. Field data were collected by James Herrera and his colleagues in the montane evergreen rainforest of Ranomafana National Park in southwestern Madagascar. They conducted diurnal and nocturnal lemur surveys at five sites (Ampatsoana, Maharira, Miaranony, Valohoaka, and Vohiparara) between 2011 and 2014. Diurnal lemur surveys were conducted at 31 transects among these five sites, whereas nocturnal lemur surveys were conducted at 26 of these sites due to logistical constraints. Habitat variables (slope, roughness, location, topogaphic position index, elevation, flow direction, and aspect) were collected along each transects. Additionally, vegetation data were collected from botanical surveys every 100 m along each transect. Camille DeSisto calculated lemur densities using a distance sampling and model averaging approach that jointly modeled for detection and density, using the R packages "unmarked" and "MuMln" (Fiske & Chandler 201; Barton 2020). Trait data were previously collected from the literature and mean trait values were calculated for each transect as part of the larger research project . 

Below is a map of all 31 project transect sites
```{r}
Sf_LemurData <- st_as_sf(lemur_data,
                             coords = c('long','lat'),
                             crs = 4326)

Sf_Sites<- Sf_LemurData %>%
  mutate(Transect_Site2 = Transect_Site) %>%
  separate(col= Transect_Site2, into="Site", sep ="_") %>%
  group_by(Transect_Site, Site) %>%
  summarise(meanSpeciesDensity = mean(Predicted),
            tpi = mean(tpi),
            roughness=mean(roughness),
            slope= mean(slope),
            aspect = mean(aspect),
            flowdir = mean(flowdir),
            WD = mean(WD))

Map_Transect<- mapview(Sf_Sites,zcol="Site", legend = TRUE, alpha=0.5, cex=8, label = "Transect_Site",layer.name = 'Site')
Map_Transect
```



\newpage

# Exploratory Analysis 

```{r}
head(lemur_data)
dim(lemur_data)

```


\newpage

# Analysis

```{r}
trait_data2 <- lemur_data %>%
  mutate(Transect_Site2 = Transect_Site)%>%
  separate(col= Transect_Site2, into="Site", sep ="_")
 

density_anova <- aov(data= trait_data2, Predicted ~ Site)
summary(density_anova)

#I reject the null hypothesis and conclude that there is a significant difference in lemur densities between different sites (p = 0.009). 
TukeyHSD(density_anova)
# There is a significant difference in lemur densities between Miaranony and Ampatsoana, Miaranony and Maharira, 
#and Miaranony and Vohiparara 

anova_groups <- HSD.test(density_anova, "Site", group=TRUE)
# the predicted groups according to their lemur densities are Miaranony and Valohoaka being in group a 
# and Valohoaka, Vohiparara, Ampatsoana, and Maharira in group b 

density_aov_plot <- ggplot(data = trait_data2, aes(x = Site, y = Predicted))+
  geom_boxplot()+
  ylab("Lemur Density (N Individuals/"~(Km^2))+
  theme_classic()
#based on the plot it looks like it might be outliers that are driving the pattern we see of higher lemur densities
# in Miaranony and Valohoaka 


density_anova2 <- aov(data= trait_data2, Predicted ~ Species)
summary(density_anova2)

#I reject the null hypothesis and conclude that there is a significant difference in lemur densities between different species (p < 0.001).

TukeyHSD(density_anova2)

anova_groups <- HSD.test(density_anova2, "Species", group=TRUE)
# the lemur species fall into four groups according to their densities 
#What is interesting is that the groups do not seem to be organized by taxonomic family, body size, or whether they are nocturnal. diurnal

density_aov_scatterplot <- ggplot(data = trait_data2, aes(x = reorder(Species, Predicted, FUN = median), y = Predicted))+
  geom_boxplot()+
  ylab("Lemur Density (N Individuals/"~(Km^2))+
  xlab("Species")+
  theme_classic()+
  scale_x_discrete(labels= c("V. variegata", "L. microdon", "A. laniger", "C. crossleyi", "E. rufifrons", "H. gruseus", "M. rufus", "P. edwardsi", "E. rubriventer"))+
  theme(axis.text.x = element_text(angle = 45, vjust=0.5))
  
```



## Question 1: Which landscape-level characteristics and plant functional traits influence lemur density?

```{r}
#More analyses using linear models
traitdata_subset <- select(trait_data2, logFruitLength:logSLA, Predicted, slope, aspect, lat, long)
lemur_density_Corr <- cor(traitdata_subset)
corrplot(lemur_density_Corr, method = "ellipse")
#The correlation plot matrix indicates that there are slight positive correlations between our response variable (Predicted) and multiple explanatory variables.

Fruit_trait_plot <- ggplot(traitdata_subset, aes(x = logFruitLength, y = Predicted, color = logNitrogen)) +
  geom_point()
print(Fruit_trait_plot)
# plot to visually explore the relationship between some of fruit trait variables that stood out in the correlation plot matrix and lemur density

Fruit_trait_nutrient_plot2 <- ggplot(traitdata_subset, aes(x = logProtein, y = Predicted, color = logTannins)) +
  geom_point()
print(Fruit_trait_nutrient_plot2)
# plot to visually explore the relationship between two other fruit trait variables that stood out in the correlation plot matrix and lemur density

#Creating a linear model with random effects
lemur_dens_lmer1 <- lmer(data = trait_data2, Predicted ~ logSeedLength + logNitrogen + lat + logSeedWidth + logTannins + roughness + long + logSugar + logSLA + slope + Site + logFruitLength + logFat + aspect + logFruitWidth + logProtein + (1|Species) + (1|Transect_Site))
summary(lemur_dens_lmer1)

#Checking whether the linear model conforms to the assumptions of linear models
par(mfrow = c(2,2), mar=c(4,4,4,4))
plot(lmer_Species_TS1)
par(mfrow = c(1,1))
#There appears to be a balance of positive and negative residuals, which is a good sign. However, there appears to be a strange pattern of three seperate lines with negative slopes

qqnorm(trait_data2$Predicted); qqline(trait_data2$Predicted)
#This qqplot provides information on the normality of the response variable. The data doesn't follow a normal distribution that well, but I don't think its terrible

#Reducing the linear model using the step function
step(lmer_Species_TS1)
#The step function found that Predicted ~ logNitrogen + lat + roughness + slope + Site + logFruitLength + logFruitWidth + (1 | Species) is the best model


step_model <- lmer(data = trait_data2, Predicted ~ logNitrogen + lat + roughness + slope + Site + logFruitLength + logFruitWidth + (1 | Species))
summary(step_model)
#The model produced by the step function indicates that logNitrogen, lat, roughness, slope, SiteMaharira, SiteMiaranony, SiteValohoaka, SiteVohiparara, logFruitLength, and logFruitWidth are significant variables

#Reducing the linear model manually
lemur_dens_lmer2 <- update(lemur_dens_lmer1,~.-logSLA)
summary(lemur_dens_lmer2)

lemur_dens_lmer3 <- update(lemur_dens_lmer2,~.-logSeedLength)
summary(lemur_dens_lmer3)

lemur_dens_lmer4 <- update(lemur_dens_lmer3,~.-aspect)
summary(lemur_dens_lmer4)

lemur_dens_lmer5 <- update(lemur_dens_lmer4,~.-logTannins)
summary(lemur_dens_lmer5)

lemur_dens_lmer6 <- update(lemur_dens_lmer5,~.-logSeedWidth)
summary(lemur_dens_lmer6)

lemur_dens_lmer7 <- update(lemur_dens_lmer6,~.-logProtein)
summary(lemur_dens_lmer7)

lemur_dens_lmer8 <- update(lemur_dens_lmer7,~.-logFat)
summary(lemur_dens_lmer8)

lemur_dens_lmer9 <- update(lemur_dens_lmer8,~.-logSugar)
summary(lemur_dens_lmer9)

lemur_dens_lmer10 <- update(lemur_dens_lmer9,~.-long)
summary(lemur_dens_lmer10)

lemur_dens_lmer11 <- update(lemur_dens_lmer10,~.-SiteMiaranony)
summary(lemur_dens_lmer11)

lrtest(lemur_dens_lmer6, lemur_dens_lmer7, lemur_dens_lmer8, lmer_Species_TS9, lemur_dens_lmer10)
AIC(lemur_dens_lmer6, lemur_dens_lmer7, lemur_dens_lmer8, lmer_Species_TS9, lemur_dens_lmer10)
#models 6 and 7 seem to have the lowest AICs, but model 10 has only significant variables, so it is the one I have selected
r.squaredGLMM(lemur_dens_lmer7)
r.squaredGLMM(lemur_dens_lmer8)
r.squaredGLMM(lemur_dens_lmer9)
r.squaredGLMM(lemur_dens_lmer10)
#lemur_dens_lmer_10 explains 46% of density

#checking the residuals of the final linear model
par(mfrow = c(2,2), mar=c(4,4,4,4))
plot(lmer_Species_TS10)
par(mfrow = c(1,1))

#Exploring drivers of density for individual species
AL_subset <- filter(trait_data2, Species == "Avahi_laniger")

AL_lm_1 <- lm(data = AL_subset, Predicted ~ logSeedLength + logNitrogen + lat + logSeedWidth + logTannins + roughness + long + logSugar + logSLA + slope + Site + logFruitLength + logFat + aspect + logFruitWidth + logProtein)
summary(AL_lm_1)

AL_lm_2 <- update(AL_lm_1,~.-logSugar)
summary(AL_lm_2)

AL_lm_3 <- update(AL_lm_2,~.-logTannins)
summary(AL_lm_3)

AL_lm_4 <- update(AL_lm_3,~.-aspect)
summary(AL_lm_4)

AL_lm_5 <- update(AL_lm_4,~.-logNitrogen)
summary(AL_lm_5)

AL_lm_6 <- update(AL_lm_5,~.-roughness)
summary(AL_lm_6)

AL_lm_7 <- update(AL_lm_6,~.-slope)
summary(AL_lm_7)

AL_lm_8 <- update(AL_lm_7,~.-logProtein)
summary(AL_lm_8)

AL_lm_9 <- update(AL_lm_8,~.-logFat)
summary(AL_lm_9)

AL_lm_10 <- update(AL_lm_9,~.-long)
summary(AL_lm_10)

AIC(AL_lm_2, AL_lm_3, AL_lm_4, AL_lm_5, AL_lm_6, AL_lm_7, AL_lm_8, AL_lm_9, AL_lm_10)
#AL_lm_7 has the lowest AIC, and explains 82% of the variation of Avahi laniger densities 
#AL_lm_10 has only significant variables, and explains 79% of the variation of Avahi laniger densities
```


## Question 2: Which landscape-level characteristics and plant functional traits influence density of individual lemur species?




\newpage

# Summary and Conclusions


\newpage

# References
<add references here if relevant, otherwise delete this section> 
